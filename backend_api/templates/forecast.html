{% extends "layout.html" %}
{% block title %}D·ª± b√°o - D·ª± b√°o Th·ªùi ti·∫øt{% endblock %}
{% block content %}
<section id="page-forecast" class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4">
        <div class=" bg-[rgb(197 210 236 / 85%)] backdrop-blur-md rounded-3xl shadow-2xl p-6 mb-6 transform hover:scale-[1.01] transition-all duration-300">
            <div class="flex flex-col md:flex-row items-center gap-4 mb-4">
                <div class="flex items-center gap-3 flex-1">
                    <div class="p-3 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl shadow-lg">
                        <i data-lucide="cloud-sun" class="w-8 h-8 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">D·ª± b√°o Th·ªùi ti·∫øt</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">D·ª± b√°o ch√≠nh x√°c v·ªõi AI</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 px-4 py-2 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 rounded-xl">
                    <i data-lucide="calendar-clock" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                    <span class="text-sm font-medium text-dark-700 dark:text-dark-200" id="current-time"></span>
                </div>
            </div>
        
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 relative">
                    <i data-lucide="map-pin" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <select id="province-select" class="w-full pl-12 pr-4 py-4 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 border-2 border-transparent hover:border-blue-300 focus:border-blue-500 dark:border-gray-600 text-gray-800 dark:text-dark rounded-2xl focus:outline-none transition-all duration-300 shadow-sm hover:shadow-md font-medium">
                        <option value="">ƒêang t·∫£i danh s√°ch t·ªânh...</option>
                    </select>
                </div>
                <button id="geolocate-btn" class="group bg-gradient-to-r from-yellow-400 to-orange-400 hover:from-yellow-500 hover:to-orange-500 text-white font-semibold rounded-2xl px-8 py-4 flex items-center justify-center gap-3 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i data-lucide="navigation" class="w-5 h-5 group-hover:rotate-45 transition-transform duration-300"></i>
                    <span>V·ªã tr√≠ c·ªßa t√¥i</span>
                </button>
            </div>
        </div>

        <div id="loading-spinner" class="bg-blue-100/90 dark:bg-blue-900/70 backdrop-blur-md rounded-3xl shadow-xl p-6 mb-6 text-center hidden">
            <div class="flex flex-col items-center gap-3">
                <div class="relative">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-200 border-t-blue-600"></div>
                    <i data-lucide="cloud" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-5 h-5 text-blue-600"></i>
                </div>
                <span class="text-gray-700 dark:text-gray-300 font-medium">ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu th·ªùi ti·∫øt...</span>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-[rgb(132_155_221_/70%)] backdrop-blur-md rounded-3xl shadow-2xl p-8 transform hover:scale-[1.02] transition-all duration-300">
                <div class="flex items-center gap-2 mb-6">
                    <i data-lucide="thermometer" class="w-5 h-5 text-blue-500"></i>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white" id="forecast-location">Th·ªùi ti·∫øt t·∫°i</h2>
                </div>

                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-6">
                        <div class="relative">
                            <div class="absolute inset-0 bg-gradient-to-br from-yellow-200 to-orange-200 dark:from-yellow-600 dark:to-orange-600 rounded-full blur-2xl opacity-30"></div>
                            <span class="relative text-7xl animate-bounce-slow" id="current-icon">üå§Ô∏è</span>
                        </div>
                        <div>
                            <div class="text-6xl font-bold bg-gradient-to-br from-blue-600 to-purple-600 bg-clip-text text-transparent" id="current-temp">--¬∞</div>
                            <div class="text-dark-600 dark:text-dark-400 text-sm mt-2 font-medium" id="feels-like">C·∫£m gi√°c nh∆∞ --¬∞</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-semibold text-gray-700 dark:text-dark-300 bg-[rgb(223_235_251_/95%)] px-4 py-2 rounded-xl" id="weather-type">--</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 rounded-2xl hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <i data-lucide="droplets" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">ƒê·ªô ·∫©m</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark" id="humidity">--%</div>
                    </div>
                    <div class="text-center p-4 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 rounded-2xl hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <i data-lucide="wind" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Gi√≥</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark" id="wind-speed">--</div>
                    </div>
                    <div class="text-center p-4 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 rounded-2xl hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <i data-lucide="eye" class="w-8 h-8 text-purple-500 mx-auto mb-2"></i>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">T·∫ßm nh√¨n</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark" id="visibility">--</div>
                    </div>
                    <div class="text-center p-4 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 rounded-2xl hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <div class="text-3xl mb-2">üå°Ô∏è</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">√Åp su·∫•t</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark" id="pressure">--</div>
                    </div>
                    <div class="text-center p-4 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 rounded-2xl hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <i data-lucide="sun" class="w-8 h-8 text-yellow-500 mx-auto mb-2"></i>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">UV</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark" id="uv-index">--</div>
                    </div>
                    <div class="text-center p-4 bg-[rgb(223_235_251_/95%)] dark:from-gray-700 dark:to-gray-600 rounded-2xl hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <i data-lucide="cloud-rain" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">M∆∞a</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark" id="precipitation">--</div>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-400 via-pink-500 to-purple-600 rounded-3xl shadow-2xl p-8 text-white transform hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
                <div class="absolute bottom-0 left-0 w-48 h-48 bg-yellow-300/20 rounded-full blur-3xl"></div>
            
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="sunrise" class="w-5 h-5"></i>
                        <h3 class="text-xl font-bold">B√¨nh minh / Ho√†ng h√¥n</h3>
                    </div>
                    <div class="flex justify-around items-center mb-8">
                        <div class="text-center transform hover:scale-110 transition-transform duration-300">
                            <div class="text-5xl mb-3">üåÖ</div>
                            <div class="text-sm opacity-90 mb-1">B√¨nh minh</div>
                            <div class="text-3xl font-bold drop-shadow-lg" id="sunrise-time">--</div>
                        </div>
                        <div class="h-20 w-px bg-white/30"></div>
                        <div class="text-center transform hover:scale-110 transition-transform duration-300">
                            <div class="text-5xl mb-3">üåá</div>
                            <div class="text-sm opacity-90 mb-1">Ho√†ng h√¥n</div>
                            <div class="text-3xl font-bold drop-shadow-lg" id="sunset-time">--</div>
                        </div>
                    </div>
                    
                    <div class="bg-white/20 backdrop-blur-xl rounded-2xl p-6 border border-white/30">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="thermometer" class="w-5 h-5"></i>
                            <h4 class="font-semibold text-lg">Nhi·ªát ƒë·ªô trong ng√†y</h4>
                        </div>
                        <div class="grid grid-cols-4 gap-3">
                            <div class="text-center">
                                <div class="text-4xl mb-2">‚òÄÔ∏è</div>
                                <div class="text-sm opacity-90 mb-1">Ng√†y</div>
                                <div class="text-lg font-bold drop-shadow-lg" id="day-temp">--¬∞/--¬∞</div>
                            </div>
                            <div class="text-center">
                                <div class="text-4xl mb-2">üåô</div>
                                <div class="text-sm opacity-90 mb-1">ƒê√™m</div>
                                <div class="text-lg font-bold drop-shadow-lg" id="night-temp">--¬∞/--¬∞</div>
                            </div>
                            <div class="text-center">
                                <div class="text-4xl mb-2">üåÖ</div>
                                <div class="text-sm opacity-90 mb-1">S√°ng</div>
                                <div class="text-lg font-bold drop-shadow-lg" id="morning-temp">--¬∞/--¬∞</div>
                            </div>
                            <div class="text-center">
                                <div class="text-4xl mb-2">üåÜ</div>
                                <div class="text-sm opacity-90 mb-1">T·ªëi</div>
                                <div class="text-lg font-bold drop-shadow-lg" id="evening-temp">--¬∞/--¬∞</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="bg-[rgb(132_155_221_/70%)] backdrop-blur-md rounded-3xl shadow-2xl p-8 mb-6">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="clock" class="w-5 h-5 text-blue-500"></i>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">D·ª± b√°o theo gi·ªù (24h t·ªõi)</h2>
            </div>
            <div id="hourly-forecast-container" class="overflow-x-auto scrollbar-modern">
                <div class="flex gap-4 pb-4">
            </div>
            </div>
        </div>
        <div id="ml-notice" class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/50 dark:to-pink-900/50 border-l-4 border-purple-500 rounded-2xl p-6 mb-6 hidden backdrop-blur-sm shadow-lg">
            <!-- <div class="flex items-center gap-4">
                <div class="text-4xl">ü§ñ</div>
                <div class="flex-1">
                    <div class="font-bold text-purple-800 dark:text-purple-200 text-lg mb-1">D·ªØ li·ªáu ƒë∆∞·ª£c d·ª± ƒëo√°n b·∫±ng AI/ML</div>
                    <div class="text-sm text-purple-700 dark:text-purple-300">
                        D·ªØ li·ªáu ƒë∆∞·ª£c d·ª± ƒëo√°n b·∫±ng thu·∫≠t to√°n m√°y h·ªçc d·ª±a tr√™n l·ªãch s·ª≠ th·ªùi ti·∫øt (ƒê∆∞·ª£c ƒë√°nh d·∫•u ü§ñ trong bi·ªÉu ƒë·ªì gi·ªù).
                    </div>
                </div>
                <i data-lucide="sparkles" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
            </div> -->
        </div> 
        
        <div class="bg-[rgb(132_155_221_/70%)] backdrop-blur-md rounded-3xl shadow-2xl p-8 mb-6">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="calendar-days" class="w-5 h-5 text-blue-500"></i>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">D·ª± b√°o 7 ng√†y t·ªõi</h2>
            </div>
            <div id="daily-forecast-container" class="space-y-4"></div>
        </div>
        <div class="bg-[rgb(132_155_221_/70%)] backdrop-blur-md rounded-3xl shadow-2xl p-8 mb-6">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="bar-chart-3" class="w-6 h-6 text-blue-500"></i>
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Bi·ªÉu ƒë·ªì chi ti·∫øt (48h t·ªõi)</h2>
            </div>
        
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-[rgb(223_235_251_/95%)] backdrop-blur-md p-8 rounded-3xl shadow-2xl transform hover:scale-[1.02] transition-all duration-300">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="thermometer-sun" class="w-5 h-5 text-orange-500"></i>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-dark">Nhi·ªát ƒë·ªô & ƒê·ªô ·∫©m</h3>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <div style="height: 300px; position: relative;">
                            <canvas id="chart-temp-humidity"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-[rgb(223_235_251_/95%)] backdrop-blur-md p-8 rounded-3xl shadow-2xl transform hover:scale-[1.02] transition-all duration-300">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="cloud-drizzle" class="w-5 h-5 text-blue-500"></i>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-dark">L∆∞·ª£ng m∆∞a</h3>
                    </div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="chart-precipitation"></canvas>
                        </div>
                </div>
                <div class="bg-[rgb(223_235_251_/95%)] backdrop-blur-md p-8 rounded-3xl shadow-2xl transform hover:scale-[1.02] transition-all duration-300">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="wind" class="w-5 h-5 text-green-500"></i>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-dark">T·ªëc ƒë·ªô gi√≥</h3>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="chart-wind"></canvas>
                    </div>
                </div>
                <div class="bg-[rgb(223_235_251_/95%)] backdrop-blur-md p-8 rounded-3xl shadow-2xl transform hover:scale-[1.02] transition-all duration-300">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="gauge" class="w-5 h-5 text-purple-500"></i>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-dark">√Åp su·∫•t</h3>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="chart-pressure"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .animate-bounce-slow { animation: bounce-slow 3s ease-in-out infinite; }
</style>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    let selectedDays = 7;
    let charts = {};
    let currentForecastData = null;
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        initForecastPage();
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
    });

    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString('vi-VN', {
            weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
    }

    async function initForecastPage() {
        await loadProvinces();
        document.getElementById('geolocate-btn').addEventListener('click', getUserLocation);
        const provinceSelect = document.getElementById('province-select');
        provinceSelect.addEventListener('change', (e) => {
            if (e.target.value) loadForecast(e.target.value);
        });

        // 2. D·ª± b√°o m·∫∑c ƒë·ªãnh b·∫±ng ƒë·ªãnh v·ªã (thay v√¨ m·∫∑c ƒë·ªãnh 'H√† N·ªôi')
        await getUserLocation(); 
        
        // N·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠, m·∫∑c ƒë·ªãnh l√† H√† N·ªôi (ho·∫∑c t·ªânh ƒë·∫ßu ti√™n trong list)
        if (!provinceSelect.value) {
            const defaultProvince = provinceSelect.options.length > 1 ? provinceSelect.options[1].value : 'H√† N·ªôi';
            provinceSelect.value = defaultProvince;
            loadForecast(defaultProvince);
        }
    }

    async function loadProvinces() {
        try {
            const response = await fetch('/api/provinces');
            const provinces = await response.json();
            const provinceSelect = document.getElementById('province-select');
            provinceSelect.innerHTML = '<option value="">Ch·ªçn t·ªânh th√†nh...</option>';
            provinces.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                option.textContent = p.name;
                provinceSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading provinces:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·ªânh th√†nh');
        }
    }

    async function getUserLocation() {
        if (!navigator.geolocation) {
            alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
            return;
        }
        document.getElementById('loading-spinner').classList.remove('hidden');
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    const { latitude, longitude } = position.coords;
                    console.log('V·ªã tr√≠ hi·ªán t·∫°i:', latitude, longitude);
                
                    // L·∫•y danh s√°ch t·ªânh t·ª´ database
                    const provincesResponse = await fetch('/api/provinces');
                    const provinces = await provincesResponse.json();
                
                    // T√¨m t·ªânh g·∫ßn nh·∫•t d·ª±a tr√™n kho·∫£ng c√°ch
                    let nearestProvince = null;
                    let minDistance = Infinity;
                
                    provinces.forEach(province => {
                        const distance = calculateDistance(
                            latitude,
                            longitude,
                            province.latitude,
                            province.longitude
                        );
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestProvince = province;
                        }
                    });
                
                    if (nearestProvince) {
                        console.log('T·ªânh g·∫ßn nh·∫•t:', nearestProvince.name, 'Kho·∫£ng c√°ch:', minDistance.toFixed(2), 'km');
                        document.getElementById('province-select').value = nearestProvince.name;
                        loadForecast(nearestProvince.name);
                    } else {
                        alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh t·ªânh th√†nh');
                        document.getElementById('loading-spinner').classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Geolocation error:', error);
                    alert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n');
                    document.getElementById('loading-spinner').classList.add('hidden');
                }
            },
            (error) => {
                console.error('Geolocation error:', error);
                // N·∫øu ng∆∞·ªùi d√πng t·ª´ ch·ªëi ho·∫∑c l·ªói, v·∫´n ·∫©n loading v√† ƒë·ªÉ logic initForecastPage x·ª≠ l√Ω m·∫∑c ƒë·ªãnh
                document.getElementById('loading-spinner').classList.add('hidden');
                // B√°o l·ªói nh·∫π
                console.log('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠, s·∫Ω s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh.');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

// H√†m t√≠nh kho·∫£ng c√°ch gi·ªØa 2 ƒëi·ªÉm (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // B√°n k√≠nh Tr√°i ƒê·∫•t (km)
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function toRad(degrees) {
    return degrees * Math.PI / 180;
}
    let isLoading = false;
    async function loadForecast(province) {
        if (isLoading) return;
        isLoading = true;
        document.getElementById('loading-spinner').classList.remove('hidden');
        try {
            const response = await fetch(`/api/forecast?province=${province}&days=${selectedDays}`);
            const data = await response.json();
            
            // L∆∞u tr·ªØ t√™n t·ªânh/th√†nh ph·ªë
            data.location = province;

            renderCurrentWeather(data);
            renderHourlyForecast(data); 
            renderDailyForecast(data);
            renderCharts(data);
        } catch (error) {
            console.error('Error loading forecast:', error);
        } finally {
            document.getElementById('loading-spinner').classList.add('hidden');
            lucide.createIcons();
            isLoading = false;
        }
    }

    function renderCurrentWeather(data) {
        // 1. Th√™m t·ªânh ƒëang d·ª± ƒëo√°n v√†o ti√™u ƒë·ªÅ
        document.getElementById('forecast-location').textContent = `Th·ªùi ti·∫øt t·∫°i ${data.location}`;

        const current = data.current || {};
        const daily = data.daily || {};
        
        // Update current weather
        document.getElementById('current-temp').textContent = `${Math.round(current.temperature_2m || 0)}¬∞`;
        document.getElementById('feels-like').textContent = `C·∫£m gi√°c nh∆∞ ${Math.round(current.apparent_temperature || current.temperature_2m || 0)}¬∞`;
        document.getElementById('weather-type').textContent = getWeatherType(current.weather_code);
        document.getElementById('current-icon').textContent = getWeatherIcon(current.weather_code);
        document.getElementById('humidity').textContent = `${Math.round(current.relative_humidity_2m || 0)}%`;
        document.getElementById('wind-speed').textContent = `${(current.wind_speed_10m || 0).toFixed(1)} km/h`;
        document.getElementById('visibility').textContent = `${((current.visibility || 0) / 1000).toFixed(1)} km`;
        document.getElementById('pressure').textContent = `${Math.round(current.pressure_msl || 0)} hPa`;
        document.getElementById('uv-index').textContent = (current.uv_index || 0).toFixed(1);
        document.getElementById('precipitation').textContent = `${(current.precipitation || 0).toFixed(1)} mm`;

        // Update sunrise/sunset
        if (daily.sunrise && daily.sunset && daily.sunrise[0] && daily.sunset[0]) {
            const sunrise = new Date(daily.sunrise[0]).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const sunset = new Date(daily.sunset[0]).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('sunrise-time').textContent = sunrise;
            document.getElementById('sunset-time').textContent = sunset;
        }

        // C·∫≠p nh·∫≠t Nhi·ªát ƒë·ªô trong ng√†y (Gi·ªØ nguy√™n logic c≈©)
        const hourly = data.hourly || {};
        const times = hourly.time?.slice(0, 24) || [];
        const temps = hourly.temperature_2m?.slice(0, 24) || [];

        let [dayMax, dayMin] = calcTempRange(12, 18, times, temps);
        document.getElementById('day-temp').textContent = `${Math.round(dayMax)}¬∞/${Math.round(dayMin)}¬∞`;

        let [nightMax, nightMin] = calcTempRange(0, 6, times, temps);
        document.getElementById('night-temp').textContent = `${Math.round(nightMax)}¬∞/${Math.round(nightMin)}¬∞`;

        let [morningMax, morningMin] = calcTempRange(6, 12, times, temps);
        document.getElementById('morning-temp').textContent = `${Math.round(morningMax)}¬∞/${Math.round(morningMin)}¬∞`;

        let [eveningMax, eveningMin] = calcTempRange(18, 24, times, temps);
        document.getElementById('evening-temp').textContent = `${Math.round(eveningMax)}¬∞/${Math.round(eveningMin)}¬∞`;
    }

    function renderHourlyForecast(data) {
        const container = document.getElementById('hourly-forecast-container').firstElementChild;
        container.innerHTML = '';
        const hourly = data.hourly || {};
        const times = hourly.time || [];
        const mlNotice = document.getElementById('ml-notice');
        
        // Hi·ªÉn th·ªã th√¥ng b√°o ML n·∫øu d·ª± ƒëo√°n ML ƒë∆∞·ª£c s·ª≠ d·ª•ng
        if (data.ml_prediction && data.ml_prediction.predicted_temperature && data.ml_prediction.predicted_temperature.length > 0) {
            mlNotice.classList.remove('hidden');
        } else {
            mlNotice.classList.add('hidden');
        }
    
        const now = new Date();
        // L·∫•y 24 gi·ªù ti·∫øp theo, bao g·ªìm c·∫£ gi·ªù hi·ªán t·∫°i n·∫øu c√≥
        const next24Hours = times.filter((time, i) => {
            const hourDate = new Date(time);
            return hourDate >= now; 
        }).slice(0, 24);

        next24Hours.forEach((time, i) => {
            const hourDate = new Date(time);
            
            // T√¨m index c·ªßa th·ªùi gian n√†y trong m·∫£ng hourly g·ªëc (ƒë√£ merge)
            const hourlyIndex = hourly.time.indexOf(time); 
            
            // Ki·ªÉm tra xem d·ªØ li·ªáu n√†y c√≥ ph·∫£i l√† t·ª´ ML hay kh√¥ng
            let isML = false;
            
            
            const card = document.createElement('div');
            card.className = 'flex-none w-32 p-4 bg-[rgb(223_235_251_/95%)] rounded-2xl text-center shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1';
            
            card.innerHTML = `
                <div class="text-sm font-semibold text-gray-800 dark:text-dark mb-2">${hourDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                <div class="text-3xl mb-2">${getWeatherIcon(hourly.weather_code?.[hourlyIndex])}</div>
                <div class="text-lg font-bold text-gray-800 dark:text-dark">${Math.round(hourly.temperature_2m?.[hourlyIndex] || 0)}¬∞${isML ? ' ü§ñ' : ''}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${(hourly.precipitation?.[hourlyIndex] || 0).toFixed(1)} mm</div>
            `;
            container.appendChild(card);
        });
    }

    function renderDailyForecast(data) {
        const container = document.getElementById('daily-forecast-container');
        container.innerHTML = '';
        const daily = data.daily || {};
        const times = daily.time || [];

        times.forEach((time, i) => {
            const date = new Date(time);
            const dayName = getDayName(date);
            const isToday = i === 0;
            const card = document.createElement('div');
            card.className = 'group flex items-center justify-between p-6 bg-[rgb(223_235_251_/95%)] rounded-2xl hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 border border-gray-100 dark:border-gray-600';
            card.innerHTML = `
                <div class="flex items-center gap-5 flex-1">
                    <div class="text-5xl group-hover:scale-110 transition-transform duration-300">${getWeatherIcon(daily.weather_code?.[i])}</div>
                    <div>
                        <div class="font-bold text-xl text-gray-800 dark:text-dark mb-1">
                            ${isToday ? 'üîµ H√¥m nay' : dayName}, ${date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })}
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${getWeatherType(daily.weather_code?.[i])}</div>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="text-center">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Nhi·ªát ƒë·ªô</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark">${Math.round(daily.temperature_2m_max?.[i] || 0)}¬∞ / ${Math.round(daily.temperature_2m_min?.[i] || 0)}¬∞</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">M∆∞a</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark">${(daily.precipitation_sum?.[i] || 0).toFixed(1)} mm</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Gi√≥</div>
                        <div class="text-lg font-bold text-gray-800 dark:text-dark">${(daily.wind_speed_10m_max?.[i] || 0).toFixed(1)} km/h</div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function renderCharts(data) {
        const hourly = data.hourly || {};
        const times = (hourly.time || []).slice(0, 48); // Next 48 hours
        const labels = times.map(time => new Date(time).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }));

        // Destroy existing charts if they exist
        Object.values(charts).forEach(chart => chart.destroy());

        // Temperature & Humidity Chart
        charts.tempHumidity = new Chart(document.getElementById('chart-temp-humidity'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Nhi·ªát ƒë·ªô (¬∞C)',
                        data: (hourly.temperature_2m || []).slice(0, 48),
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'ƒê·ªô ·∫©m (%)',
                        data: (hourly.relative_humidity_2m || []).slice(0, 48),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                scales: {
                    y: { position: 'left', title: { display: true, text: 'Nhi·ªát ƒë·ªô (¬∞C)' }, min: 0, max: 40 }, // Th√™m min/max
                    y1: { position: 'right', title: { display: true, text: 'ƒê·ªô ·∫©m (%)' }, grid: { drawOnChartArea: false }, min: 0, max: 100 },
                    x: { title: { display: true, text: 'Th·ªùi gian' } }
                }
            }
        });

        // Precipitation Chart
        charts.precipitation = new Chart(document.getElementById('chart-precipitation'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'L∆∞·ª£ng m∆∞a (mm)',
                    data: (hourly.precipitation || []).slice(0, 48),
                    backgroundColor: '#3b82f6',
                    borderColor: '#1d4ed8',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                scales: {
                    y: { beginAtZero: true, min: 0, max: 10, title: { display: true, text: 'L∆∞·ª£ng m∆∞a (mm)' } }, // Th√™m min/max
                    x: { title: { display: true, text: 'Th·ªùi gian' } }
                }
            }
        });

        // Wind Speed Chart
        charts.wind = new Chart(document.getElementById('chart-wind'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'T·ªëc ƒë·ªô gi√≥ (km/h)',
                    data: (hourly.wind_speed_10m || []).slice(0, 48),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                scales: {
                    y: { beginAtZero: true, min: 0, max: 20, title: { display: true, text: 'T·ªëc ƒë·ªô gi√≥ (km/h)' } }, // Th√™m min/max
                    x: { title: { display: true, text: 'Th·ªùi gian' } }
                }
            }
        });

        // Pressure Chart
        charts.pressure = new Chart(document.getElementById('chart-pressure'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '√Åp su·∫•t (hPa)',
                    data: (hourly.pressure_msl || []).slice(0, 48),
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                scales: {
                    y: { min: 900, max: 1100, title: { display: true, text: '√Åp su·∫•t (hPa)' } }, // Th√™m min/max
                    x: { title: { display: true, text: 'Th·ªùi gian' } }
                }
            }
        });
    }

    // H√†m t√≠nh max/min temp cho kho·∫£ng gi·ªù
    function calcTempRange(start, end, times, temps) {
        let tempsInRange = [];
        times.forEach((time, i) => {
            let hour = new Date(time).getHours();
            if (start <= hour && hour < end) {
                tempsInRange.push(temps[i]);
            }
        });
        if (tempsInRange.length > 0) {
            return [Math.max(...tempsInRange), Math.min(...tempsInRange)];
        }
        return [0, 0];
    }

    function getWeatherIcon(code) {
        const weatherIcons = {
            0: '‚òÄÔ∏è', // Clear sky
            1: 'üå§Ô∏è', // Mainly clear
            2: '‚õÖ', // Partly cloudy
            3: '‚òÅÔ∏è', // Overcast
            45: 'üå´Ô∏è', // Fog
            48: 'üå´Ô∏è', // Depositing rime fog
            51: 'üå¶Ô∏è', // Light drizzle
            53: 'üå¶Ô∏è', // Moderate drizzle
            55: 'üåßÔ∏è', // Dense drizzle
            61: 'üåßÔ∏è', // Light rain
            63: 'üåßÔ∏è', // Moderate rain
            65: '‚õàÔ∏è', // Heavy rain
            71: '‚ùÑÔ∏è', // Light snow
            73: '‚ùÑÔ∏è', // Moderate snow
            75: 'üå®Ô∏è', // Heavy snow
            95: '‚õàÔ∏è', // Thunderstorm
            96: '‚õàÔ∏è', // Thunderstorm with light hail
            99: '‚õàÔ∏è'  // Thunderstorm with heavy hail
        };
        return weatherIcons[code] || 'üå§Ô∏è';
    }

    function getWeatherType(code) {
        const weatherTypes = {
            0: 'Tr·ªùi quang',
            1: 'Tr·ªùi √≠t m√¢y',
            2: 'Tr·ªùi m√¢y r·∫£i r√°c',
            3: 'Tr·ªùi nhi·ªÅu m√¢y',
            45: 'S∆∞∆°ng m√π',
            48: 'S∆∞∆°ng m√π d√†y',
            51: 'M∆∞a ph√πn nh·∫π',
            53: 'M∆∞a ph√πn v·ª´a',
            55: 'M∆∞a ph√πn d√†y',
            61: 'M∆∞a nh·∫π',
            63: 'M∆∞a v·ª´a',
            65: 'M∆∞a to',
            71: 'Tuy·∫øt nh·∫π',
            73: 'Tuy·∫øt v·ª´a',
            75: 'Tuy·∫øt d√†y',
            95: 'Gi√¥ng b√£o',
            96: 'Gi√¥ng b√£o k√®m m∆∞a ƒë√° nh·∫π',
            99: 'Gi√¥ng b√£o k√®m m∆∞a ƒë√° n·∫∑ng'
        };
        return weatherTypes[code] || 'Kh√¥ng x√°c ƒë·ªãnh';
    }

    function getDayName(date) {
        const days = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
        return days[date.getDay()];
    }
</script>
{% endblock %}