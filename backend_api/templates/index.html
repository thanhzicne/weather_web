{% extends "layout.html" %}
{% block title %}Trang ch·ªß - D·ª± b√°o Th·ªùi ti·∫øt AI{% endblock %}

{% block content %}
<div class="fixed inset-0 -z-10 h-full w-full bg-gradient-to-br from-blue-50 via-blue-100 to-purple-100 dark:from-gray-900 dark:via-blue-900 dark:to-purple-900">
    <div class="absolute top-0 right-0 -mr-20 -mt-20 w-96 h-96 rounded-full bg-blue-400/20 blur-3xl"></div>
    <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-80 h-80 rounded-full bg-purple-400/20 blur-3xl"></div>
</div>

<div class="min-h-screen container mx-auto px-4 py-8">
    
    <div class="flex flex-col lg:flex-row items-center justify-between gap-12 py-12 lg:py-20">
        
        <div class="flex-1 text-center lg:text-left space-y-8 animate-fade-in-up">
            <div class="space-y-4">
                <!-- <span class="inline-block px-4 py-1.5 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 text-sm font-semibold tracking-wide shadow-sm">
                    ‚ú® T√≠ch h·ª£p AI & Machine Learning
                </span> -->
                <h1 class="text-5xl lg:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 leading-tight pb-2">
                    D·ª± b√°o th·ªùi ti·∫øt <br> Ch√≠nh x√°c & Hi·ªán ƒë·∫°i
                </h1>
                <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto lg:mx-0">
                    C·∫≠p nh·∫≠t th√¥ng tin th·ªùi ti·∫øt theo th·ªùi gian th·ª±c v√† d·ª± b√°o b√£o s·ªõm nh·ªù c√¥ng ngh·ªá Machine Learning.
                </p>
            </div>

            <div class="relative max-w-md mx-auto lg:mx-0 group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="h-6 w-6 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input type="text" id="province-search" list="province-list" 
                    class="block w-full pl-12 pr-4 py-4 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border border-gray-200 dark:border-gray-700 rounded-2xl shadow-lg focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 text-lg text-white transition-all outline-none"
                    placeholder="Nh·∫≠p t√™n t·ªânh/th√†nh ph·ªë..." autocomplete="off">
                <datalist id="province-list">
                    </datalist>
                <button id="search-btn" class="absolute right-2 top-2 bottom-2 px-6 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-medium rounded-xl transition-all shadow-md hover:shadow-lg transform active:scale-95">
                    Xem
                </button>
            </div>
            
            <div class="flex items-center justify-center lg:justify-start gap-4 text-sm text-gray-500 dark:text-gray-400">
                <i data-lucide="map-pin" class="w-4 h-4"></i>
                <span id="location-status">ƒêang t√¨m v·ªã tr√≠ c·ªßa b·∫°n...</span>
            </div>
        </div>

        <div class="flex-1 w-full max-w-md relative animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-300 rounded-full mix-blend-multiply filter blur-2xl opacity-70 animate-blob"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-blue-300 rounded-full mix-blend-multiply filter blur-2xl opacity-70 animate-blob animation-delay-2000"></div>

            <div id="hero-card" class="relative bg-white/40 dark:bg-gray-800/40 backdrop-blur-xl border border-white/50 dark:border-gray-600/50 rounded-[2rem] p-8 shadow-2xl transition-all hover:scale-[1.02] cursor-pointer">
                <div id="hero-loading" class="absolute inset-0 flex items-center justify-center bg-white/50 dark:bg-gray-900/50 backdrop-blur-sm rounded-[2rem] z-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent"></div>
                </div>

                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-1" id="hero-location">--</h2>
                        <p class="text-blue-600 dark:text-blue-300 font-medium" id="hero-date">--</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-orange-400 to-yellow-400 rounded-2xl shadow-lg text-white">
                        <span class="text-4xl" id="hero-icon">üå§Ô∏è</span>
                    </div>
                </div>

                <div class="flex items-baseline mb-6">
                    <span class="text-7xl font-bold text-gray-900 dark:text-white tracking-tighter" id="hero-temp">--</span>
                    <span class="text-4xl font-normal text-gray-600 dark:text-gray-300 align-top">¬∞</span>
                </div>

                <div class="text-lg font-medium text-gray-700 dark:text-gray-200 mb-8 px-4 py-2 bg-white/30 dark:bg-gray-700/30 rounded-xl inline-block" id="hero-desc">
                    --
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="text-center p-3 rounded-2xl bg-white/50 dark:bg-gray-700/50 hover:bg-white/70 transition-colors">
                        <i data-lucide="droplets" class="w-6 h-6 text-blue-500 mx-auto mb-2"></i>
                        <p class="text-xs text-gray-500 dark:text-gray-400">ƒê·ªô ·∫©m</p>
                        <p class="font-bold text-gray-800 dark:text-white" id="hero-humidity">--%</p>
                    </div>
                    <div class="text-center p-3 rounded-2xl bg-white/50 dark:bg-gray-700/50 hover:bg-white/70 transition-colors">
                        <i data-lucide="wind" class="w-6 h-6 text-green-500 mx-auto mb-2"></i>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Gi√≥</p>
                        <p class="font-bold text-gray-800 dark:text-white" id="hero-wind">-- km/h</p>
                    </div>
                    <div class="text-center p-3 rounded-2xl bg-white/50 dark:bg-gray-700/50 hover:bg-white/70 transition-colors">
                        <i data-lucide="sun" class="w-6 h-6 text-orange-500 mx-auto mb-2"></i>
                        <p class="text-xs text-gray-500 dark:text-gray-400">UV</p>
                        <p class="font-bold text-gray-800 dark:text-white" id="hero-uv">--</p>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200/50 dark:border-gray-600/50 flex justify-between items-center">
                    <span class="text-sm text-gray-500">C·∫£m gi√°c nh∆∞ <span id="hero-feels-like" class="font-bold text-gray-700 dark:text-gray-300">--¬∞</span></span>
                    <a id="hero-link" href="#" class="text-sm font-semibold text-blue-600 hover:text-blue-700 flex items-center gap-1 group-hover:gap-2 transition-all">
                        Chi ti·∫øt <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>


    <div class="mb-12">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Th√†nh ph·ªë l·ªõn</h2>
            <a href="#" class="text-blue-600 dark:text-blue-400 font-medium hover:underline">Xem t·∫•t c·∫£</a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="city-grid">
            {% for i in range(4) %}
            <div class="bg-white/50 h-48 rounded-3xl animate-pulse"></div>
            {% endfor %}
        </div>
    </div>

</div>

<style>
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fade-in-up 0.8s ease-out forwards; }
    
    @keyframes blob {
        0% { transform: translate(0px, 0px) scale(1); }
        33% { transform: translate(30px, -50px) scale(1.1); }
        66% { transform: translate(-20px, 20px) scale(0.9); }
        100% { transform: translate(0px, 0px) scale(1); }
    }
    .animate-blob { animation: blob 7s infinite; }
    .animation-delay-2000 { animation-delay: 2s; }
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        initHomePage();
    });

    const WEATHER_ICONS = {
        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 
        45: 'üå´Ô∏è', 48: 'üå´Ô∏è', 51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 
        55: 'üåßÔ∏è', 61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: '‚õàÔ∏è', 
        71: '‚ùÑÔ∏è', 73: '‚ùÑÔ∏è', 75: 'üå®Ô∏è', 95: '‚õàÔ∏è', 
        96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
    };

    const WEATHER_DESC = {
        0: 'Tr·ªùi quang', 1: '√çt m√¢y', 2: 'M√¢y r·∫£i r√°c', 3: 'Nhi·ªÅu m√¢y',
        45: 'S∆∞∆°ng m√π', 51: 'M∆∞a ph√πn', 61: 'M∆∞a nh·∫π', 63: 'M∆∞a v·ª´a',
        65: 'M∆∞a to', 95: 'Gi√¥ng b√£o'
    };

    async function initHomePage() {
        // 1. Load Provinces for Search
        await loadProvinceList();

        // 2. Load Major Cities
        loadMajorCities(['H√† N·ªôi', 'TP. H·ªì Ch√≠ Minh', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°']);

        // 3. Auto Detect Location & Load Hero Card
        await detectUserLocation();
        
        // 4. Handle Search
        setupSearch();
    }

    // --- SEARCH LOGIC ---
    async function loadProvinceList() {
        try {
            const response = await fetch('/api/provinces');
            const provinces = await response.json();
            const datalist = document.getElementById('province-list');
            provinces.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                datalist.appendChild(option);
            });
            window.allProvinces = provinces; // Store for distance calc
        } catch (e) {
            console.error("Failed to load provinces", e);
        }
    }

    function setupSearch() {
        const input = document.getElementById('province-search');
        const btn = document.getElementById('search-btn');

        const go = () => {
            if(input.value) window.location.href = `/forecast?province=${encodeURIComponent(input.value)}`;
        };

        btn.addEventListener('click', go);
        input.addEventListener('keypress', (e) => { if(e.key === 'Enter') go(); });
    }

    // --- GEOLOCATION LOGIC (Reused from forecast.html) ---
    async function detectUserLocation() {
        const statusSpan = document.getElementById('location-status');
        
        if (!navigator.geolocation) {
            statusSpan.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.";
            loadHeroWeather('H√† N·ªôi'); // Fallback
            return;
        }

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    statusSpan.textContent = "ƒê√£ t√¨m th·∫•y v·ªã tr√≠ c·ªßa b·∫°n!";
                    const { latitude, longitude } = position.coords;
                    
                    if (!window.allProvinces) {
                         const res = await fetch('/api/provinces');
                         window.allProvinces = await res.json();
                    }

                    // Find nearest province
                    let nearest = null;
                    let minDist = Infinity;
                    window.allProvinces.forEach(p => {
                        const d = calculateDistance(latitude, longitude, p.latitude, p.longitude);
                        if(d < minDist) { minDist = d; nearest = p; }
                    });

                    if(nearest) {
                        statusSpan.innerHTML = `<span class="text-green-600">üìç B·∫°n ƒëang ·ªü g·∫ßn ${nearest.name}</span>`;
                        loadHeroWeather(nearest.name);
                    } else {
                        loadHeroWeather('H√† N·ªôi');
                    }
                } catch(e) {
                    console.error(e);
                    loadHeroWeather('H√† N·ªôi');
                }
            },
            () => {
                statusSpan.textContent = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh.";
                loadHeroWeather('H√† N·ªôi');
            }
        );
    }

    // --- WEATHER LOADING LOGIC ---
    async function loadHeroWeather(province) {
        const card = document.getElementById('hero-card');
        const loader = document.getElementById('hero-loading');
        
        try {
            const res = await fetch(`/api/forecast?province=${encodeURIComponent(province)}&days=1`);
            const data = await res.json();
            const current = data.current;

            // Render Hero Data
            document.getElementById('hero-location').textContent = province;
            document.getElementById('hero-date').textContent = new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: '2-digit', month: '2-digit' });
            
            document.getElementById('hero-temp').textContent = Math.round(current.temperature_2m);
            document.getElementById('hero-icon').textContent = WEATHER_ICONS[current.weather_code] || 'üå§Ô∏è';
            document.getElementById('hero-desc').textContent = WEATHER_DESC[current.weather_code] || 'Kh√¥ng x√°c ƒë·ªãnh';
            
            document.getElementById('hero-humidity').textContent = `${current.relative_humidity_2m}%`;
            document.getElementById('hero-wind').textContent = `${current.wind_speed_10m} km/h`;
            document.getElementById('hero-uv').textContent = current.uv_index;
            document.getElementById('hero-feels-like').textContent = `${Math.round(current.apparent_temperature)}¬∞`;
            
            document.getElementById('hero-link').href = `/forecast?province=${encodeURIComponent(province)}`;
            
            // Click card to go to details
            card.onclick = (e) => {
                if(e.target.tagName !== 'A') window.location.href = `/forecast?province=${encodeURIComponent(province)}`;
            }

        } catch (e) {
            console.error("Hero load error", e);
        } finally {
            loader.classList.add('hidden');
        }
    }

    async function loadMajorCities(cities) {
        const container = document.getElementById('city-grid');
        container.innerHTML = ''; // Clear skeletons

        const gradients = [
            'from-blue-100 to-blue-200 dark:from-blue-900/40 dark:to-blue-800/40',
            'from-orange-100 to-amber-200 dark:from-orange-900/40 dark:to-amber-800/40',
            'from-green-100 to-emerald-200 dark:from-green-900/40 dark:to-emerald-800/40',
            'from-purple-100 to-pink-200 dark:from-purple-900/40 dark:to-pink-800/40'
        ];

        for (let i = 0; i < cities.length; i++) {
            const city = cities[i];
            const bgClass = gradients[i % gradients.length];
            
            // Create Card Structure (Skeleton first or direct render)
            const div = document.createElement('div');
            div.className = `relative overflow-hidden rounded-3xl p-6 bg-gradient-to-br ${bgClass} border border-white/20 shadow-lg cursor-pointer transform transition-all duration-300 hover:scale-[1.03] hover:shadow-xl group`;
            div.onclick = () => window.location.href = `/forecast?province=${encodeURIComponent(city)}`;
            
            div.innerHTML = `
                <div class="absolute top-0 right-0 p-4 opacity-50 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="arrow-up-right" class="w-5 h-5 text-gray-700 dark:text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-1">${city}</h3>
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-xs font-medium px-2 py-1 bg-white/40 rounded-lg text-gray-700 dark:text-gray-200" id="desc-${i}">ƒêang t·∫£i...</span>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <span class="text-4xl font-bold text-gray-800 dark:text-white" id="temp-${i}">--</span>
                        <span class="text-2xl text-gray-600 dark:text-gray-300">¬∞</span>
                    </div>
                    <div class="text-5xl mb-1 transform group-hover:scale-110 transition-transform duration-300" id="icon-${i}">
                        ‚è≥
                    </div>
                </div>
            `;
            container.appendChild(div);

            // Fetch Data
            fetch(`/api/forecast?province=${encodeURIComponent(city)}&days=1`)
                .then(res => res.json())
                .then(data => {
                    const c = data.current;
                    document.getElementById(`temp-${i}`).textContent = Math.round(c.temperature_2m);
                    document.getElementById(`desc-${i}`).textContent = WEATHER_DESC[c.weather_code] || 'N/A';
                    document.getElementById(`icon-${i}`).textContent = WEATHER_ICONS[c.weather_code] || 'üå§Ô∏è';
                })
                .catch(err => console.error(err));
        }
        lucide.createIcons();
    }

    // Helper: Haversine Formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
</script>
{% endblock %}