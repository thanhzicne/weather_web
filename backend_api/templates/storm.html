{% extends "layout.html" %}
{% block title %}Dự báo Bão - Dự báo Thời tiết{% endblock %}

{% block content %}
<section id="page-storm" class="bg-gradient-to-br from-[#87CEEB] via-[#AFD7E0] to-[#E6F0FA] dark:from-gray-800 dark:to-gray-900 min-h-screen py-8 animate-gradient">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-6 animate-fade-in">Theo dõi Bão trên Biển Đông</h1>
    
    <div class="bg-white/90 dark:bg-gray-800/90 rounded-lg shadow-xl p-4 weather-card animate-pop-in">
        <div id="map-container" class="bg-[#E6F0FA] dark:bg-gray-700 rounded-lg" style="height: 60vh; border: 2px solid #AFD7E0; transition: all 0.3s ease;"></div>
    </div>
    
    <div class="mt-4 p-4 bg-[#AFD7E0] dark:bg-gray-700 border border-[#E6F0FA] dark:border-gray-600 text-gray-800 dark:text-white rounded-lg animate-slide-up">
        <h3 class="font-bold text-lg mb-2">Ghi chú Phát triển</h3>
        <p>Bản đồ này hiển thị dữ liệu từ <strong>/api/storm_track</strong>. 
        <br>Hiện tại dùng anomaly detection + LinearRegression và dữ liệu giả.
        </p>
    </div>
    <iframe width="650" height="450"
    src="https://embed.windy.com/embed2.html?lat=15.0&lon=115.0&zoom=4&level=surface&overlay=wind&menu=true&message=true&marker=true">
</iframe>
</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
    document.addEventListener('DOMContentLoaded', () => {
        initStormMap();
    });

    function initStormMap() {
        const map = L.map('map-container').setView([10.7769, 106.7009], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        fetch('/api/storm_track')
            .then(res => res.json())
            .then(data => {
                if (data.no_storm) {
                    L.marker([12.0, 109.0]).addTo(map).bindPopup(data.message).openPopup();
                } else {
                    L.polyline(data.track.coordinates, {color: '#FADBD8', dashArray: '5, 5', weight: 3}).addTo(map);
                    L.marker(data.center).addTo(map).bindPopup(`Tâm bão<br>Cảnh báo: ${data.warning}<br>Đi vào đất liền: ${data.landfall_vn ? 'Có' : 'Không'}`).openPopup();
                }
            })
            .catch(err => console.error(err));
    }
</script>
{% endblock %}